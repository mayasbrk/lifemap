<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LifeMap â€“ Ø®Ø±ÙŠØ·ØªÙƒ Ù„Ø­ÙŠØ§Ø© Ù…Ù†Ø¸Ù…Ø©</title>
    <meta name="theme-color" content="#3b82f6"/>
    <link id="manifest-link" rel="manifest">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --font-family: 'Inter', sans-serif;
            --transition-speed: 0.3s;
            --border-radius: 16px;
            --border-radius-sm: 10px;

            /* Light Theme */
            --bg-light: #f4f7fe;
            --card-bg-light: #ffffff;
            --text-light: #1a1a1a;
            --text-secondary-light: #6b7280;
            --border-light: #e5e7eb;
            --accent-light: #3b82f6;
            --accent-hover-light: #2563eb;
            --accent-soft-light: rgba(59, 130, 246, 0.1);

            /* Dark Theme */
            --bg-dark: #0f172a;
            --card-bg-dark: #1e293b;
            --text-dark: #f8fafc;
            --text-secondary-dark: #9ca3af;
            --border-dark: #334155;
            --accent-dark: #60a5fa;
            --accent-hover-dark: #3b82f6;
            --accent-soft-dark: rgba(96, 165, 250, 0.1);
        }

        [data-theme="light"] {
            --bg-color: var(--bg-light);
            --card-bg-color: var(--card-bg-light);
            --text-color: var(--text-light);
            --text-secondary-color: var(--text-secondary-light);
            --border-color: var(--border-light);
            --accent-color: var(--accent-light);
            --accent-hover-color: var(--accent-hover-light);
            --accent-soft-color: var(--accent-soft-light);
        }

        [data-theme="dark"] {
            --bg-color: var(--bg-dark);
            --card-bg-color: var(--card-bg-dark);
            --text-color: var(--text-dark);
            --text-secondary-color: var(--text-secondary-dark);
            --border-color: var(--border-dark);
            --accent-color: var(--accent-dark);
            --accent-hover-color: var(--accent-hover-dark);
            --accent-soft-color: var(--accent-soft-dark);
        }

        /* --- Base Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body {
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            font-size: 16px; line-height: 1.6;
        }
        .container { padding: 20px; padding-bottom: 100px; }
        .page { display: none; }
        .page.active { display: block; }

        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px;
        }
        h1 { font-size: 28px; font-weight: 700; margin-bottom: 0; }
        h2 { font-size: 20px; font-weight: 600; margin-bottom: 15px; }
        .page-header .actions { display: flex; gap: 8px; }
        
        /* --- Bottom Navigation Bar --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 80px;
            background-color: var(--card-bg-color); border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around; align-items: flex-start;
            padding-top: 10px; box-shadow: 0 -5px 25px rgba(0,0,0,0.07); z-index: 1000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            color: var(--text-secondary-color); transition: color 0.2s, transform 0.2s; position: relative; width: 60px;
        }
        .nav-item.active { color: var(--accent-color); font-weight: 600; }
        .nav-item:hover { transform: translateY(-3px); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .nav-item span { font-size: 12px; }
        .nav-indicator {
            position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px;
            background-color: var(--accent-color); border-radius: 50%; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .nav-item.active .nav-indicator { opacity: 1; }

        /* --- UI Components --- */
        .card {
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .btn {
            background-color: var(--accent-color); color: white; border: none; padding: 12px 20px;
            border-radius: var(--border-radius-sm); font-size: 16px; font-family: var(--font-family);
            font-weight: 600; cursor: pointer; transition: all var(--transition-speed) ease;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { background-color: var(--accent-hover-color); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-secondary { background-color: var(--accent-soft-color); color: var(--accent-color); border: none; }
        .btn-secondary:hover { background-color: var(--accent-color); color: white; }
        .icon-btn {
            background: none; border: none; cursor: pointer; color: var(--text-secondary-color);
            padding: 8px; border-radius: 50%; transition: all 0.2s;
        }
        .icon-btn:hover { background-color: var(--accent-soft-color); color: var(--accent-color); }
        .fab {
            position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px;
            border-radius: 50%; font-size: 28px;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.3);
            z-index: 999; display: flex; align-items: center; justify-content: center;
        }

        /* --- List Item Styles (General) --- */
        .list-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: var(--border-radius-sm); margin-bottom: 10px; background-color: var(--bg-color); cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .list-item:hover { transform: translateY(-2px); background-color: var(--accent-soft-color); }
        .list-item .content { flex-grow: 1; min-width: 0; }
        .list-item .title { font-weight: 600; transition: color 0.2s; }
        .list-item .subtitle { font-size: 14px; color: var(--text-secondary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .delete-btn { background: none; border: none; color: var(--text-secondary-color); cursor: pointer; transition: all 0.2s; }
        .delete-btn:hover { color: #ef4444; transform: scale(1.1); }
        
        /* --- To-Do Item Specifics --- */
        .todo-item .checkbox { width: 24px; height: 24px; border: 2px solid var(--text-secondary-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; flex-shrink: 0; background-color: transparent; }
        .todo-item.completed .checkbox { background-color: var(--accent-color); border-color: var(--accent-color); color: white; }
        .todo-item.completed .title { text-decoration: line-through; color: var(--text-secondary-color); }
        .priority-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .priority-dot.high { background-color: #ef4444; }
        .priority-dot.medium { background-color: #f97316; }
        .priority-dot.low { background-color: #84cc16; }

        /* --- Modal & Forms --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .modal-content { background-color: var(--card-bg-color); padding: 25px; border-radius: var(--border-radius); width: 100%; max-width: 500px; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: var(--text-secondary-color); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-family); font-size: 15px; }
        .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        
        /* --- Pomodoro Timer Modal --- */
        #pomodoro-modal .modal-content { text-align: center; }
        #pomodoro-timer-display { font-size: 72px; font-weight: 700; color: var(--accent-color); margin: 20px 0; font-variant-numeric: tabular-nums; }
        #pomodoro-status { font-size: 18px; font-weight: 500; color: var(--text-secondary-color); margin-bottom: 20px; }
        #pomodoro-controls button { width: 100px; }
        
        /* --- Charts --- */
        .chart-container { position: relative; height: 250px; width: 100%; }

        /* --- Graph View --- */
        #graph-view-container { width: 100%; height: 65vh; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--card-bg-color); }
        
        /* --- Animations & Misc --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .page.active { animation: fadeIn 0.5s ease-out; }
        .list-item, .card { animation: slideInUp 0.4s ease-out; }

    </style>
</head>
<body>

<div class="container">
    <div id="dashboard" class="page active">
        <div class="page-header">
            <h1><span id="greeting"></span></h1>
            <div class="actions">
                <button class="icon-btn" data-action="open-search"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="icon-btn" data-action="open-settings"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.05.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
            </div>
        </div>
        <div class="card">
            <h2>ğŸ† Ø§Ù„Ø±ØªØ¨Ø© ÙˆØ§Ù„ØªÙ‚Ø¯Ù…</h2>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div id="rank-name" style="font-size: 24px; font-weight: 600; color: var(--accent-color);"></div>
                <div style="flex-grow: 1;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary-color); margin-bottom: 5px;"><span id="xp-current"></span><span id="xp-next-rank"></span></div>
                    <div style="height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden;"><div id="xp-progress-bar" style="height: 100%; background-color: var(--accent-color); width: 0%; transition: width 0.5s ease;"></div></div>
                </div>
            </div>
        </div>
        <div class="card">
            <h2>ğŸ“Š Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h2>
            <div class="chart-container">
                <canvas id="weekly-progress-chart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>ğŸ¯ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</h2>
            <div id="dashboard-todos-list"></div>
        </div>
    </div>
    
    <div id="todos" class="page">
        <div class="page-header"><h1>Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</h1></div>
        <div id="todos-list-container"></div>
    </div>

    <div id="goals" class="page">
        <div class="page-header"><h1>Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</h1></div>
        <div id="goals-list-container"></div>
    </div>
    
    <div id="graph" class="page">
        <div class="page-header"><h1>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­ÙŠØ§Ø©</h1></div>
        <div id="graph-view-container"></div>
    </div>

    <div id="settings" class="page">
        <div class="page-header"><h1>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1></div>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color);"><label for="username-input">Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="username-input" style="width: 50%; text-align: left; direction: ltr; border: none; background: transparent; font-size: 16px; color: var(--text-color);"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color);"><span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span><label class="theme-switch" style="position: relative; display: inline-block; width: 50px; height: 28px;"><input type="checkbox" id="theme-toggle" style="opacity: 0; width: 0; height: 0;"><span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 34px;"><span class="slider-knob" style="position: absolute; content: ''; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span></span></label></div>
            <div style="padding: 15px 0;">
                <button id="reset-data-btn" class="btn btn-secondary" style="width: 100%; background-color: #ef444420; color: #ef4444;">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>
    </div>

</div>

<nav class="bottom-nav"></nav>

<button id="fab-add" class="btn fab">+</button>

<div id="modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modal-title"></h3>
        <form id="modal-form">
            <input type="hidden" id="edit-id"><input type="hidden" id="edit-type">
            <div class="form-group" id="title-group"><label for="item-title">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="item-title" required></div>
            <div class="form-group" id="description-group"><label for="item-description">Ø§Ù„ÙˆØµÙ / Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label><textarea id="item-description" rows="4"></textarea><p class="hint" style="font-size: 12px; color: var(--text-secondary-color); margin-top: 5px;">Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø·ØŒ Ø§ÙƒØªØ¨ [[Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù†ØµØ±]]</p></div>
            
            <div id="todo-fields">
                <div class="form-group">
                    <label for="todo-priority">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                    <select id="todo-priority">
                        <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                        <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
                        <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="todo-pomodoros">Ø¹Ø¯Ø¯ Ø¬Ù„Ø³Ø§Øª Ø§Ù„ØªØ±ÙƒÙŠØ² (Pomodoros)</label>
                    <input type="number" id="todo-pomodoros" value="1" min="1">
                </div>
            </div>

            <div id="goal-fields" style="display:none;">
                <div class="form-group"><label for="goal-deadline">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="date" id="goal-deadline"></div>
                 <div class="form-group">
                    <label for="goal-pillar">Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
                    <select id="goal-pillar">
                        <option value="none">Ø¨Ø¯ÙˆÙ†</option>
                        <option value="career">ğŸ’¼ Ø§Ù„Ù…Ù‡Ù†Ø©</option>
                        <option value="finance">ğŸ’° Ø§Ù„Ù…Ø§Ù„</option>
                        <option value="health">â¤ï¸â€ğŸ©¹ Ø§Ù„ØµØ­Ø©</option>
                        <option value="growth">ğŸ§  Ø§Ù„Ù†Ù…Ùˆ</option>
                    </select>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" id="modal-cancel" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="submit" class="btn">Ø­ÙØ¸</button>
            </div>
        </form>
    </div>
</div>

<div id="pomodoro-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="pomodoro-task-title"></h3>
        <div id="pomodoro-timer-display">25:00</div>
        <p id="pomodoro-status">Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²!</p>
        <div id="pomodoro-controls" class="modal-actions" style="justify-content: center;">
            <button id="pomodoro-start" class="btn">Ø§Ø¨Ø¯Ø£</button>
            <button id="pomodoro-pause" class="btn btn-secondary" style="display: none;">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
            <button id="pomodoro-reset" class="btn btn-secondary">Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>
        <button id="pomodoro-close" class="icon-btn" style="position: absolute; top: 15px; right: 15px;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
    </div>
</div>

<div id="confirmation-modal" class="modal-overlay"><div class="modal-content" style="text-align: center;"><h3 id="confirmation-title"></h3><p id="confirmation-message" style="margin: 15px 0;"></p><div class="modal-actions" style="justify-content: center;"><button type="button" id="confirmation-cancel" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button><button type="button" id="confirmation-confirm" class="btn">ØªØ£ÙƒÙŠØ¯</button></div></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const app = {
        state: {},
        charts: {},
        pomodoro: {
            timer: null,
            taskId: null,
            timeLeft: 25 * 60,
            initialTime: 25 * 60,
            isPaused: true,
            mode: 'work', // 'work', 'shortBreak', 'longBreak'
            sessions: 0,
        },
        navItems: [
            { id: 'dashboard', label: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg>` },
            { id: 'todos', label: 'Ø§Ù„Ù…Ù‡Ø§Ù…', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` },
            { id: 'goals', label: 'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h15.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 013 19.875v-6.75zM3 8.625c0-.621.504-1.125 1.125-1.25h15.75c.621 0 1.125.504 1.125 1.125v.375c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 013 9V8.625z" /></svg>` },
            { id: 'graph', label: 'Ø§Ù„Ø®Ø±ÙŠØ·Ø©', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z" /></svg>` },
        ],
        ranks: [ { name: 'Ù…Ø¨ØªØ¯Ø¦', xp: 0 }, { name: 'Ù…Ù†Ø¸Ù…', xp: 100 }, { name: 'Ù…Ø«Ø§Ø¨Ø±', xp: 300 }, { name: 'Ù…ÙÙ†Ø¬Ø²', xp: 700 }, { name: 'Ø®Ø¨ÙŠØ±', xp: 1500 }, { name: 'Ø³ÙŠØ¯ Ø§Ù„Ø­ÙŠØ§Ø©', xp: 3000 } ],
        
        init() { this.loadState(); this.setupEventListeners(); this.applyTheme(this.state.settings.theme); this.renderNav(); this.navigateTo(this.state.currentPage || 'dashboard', true); this.initPWA(); },
        loadState() {
            const savedState = localStorage.getItem('lifeMapState');
            if (savedState) {
                this.state = JSON.parse(savedState);
                if(!this.state.todos) this.state.todos = [];
            } else { this.resetState(); }
        },
        resetState() {
            this.state = {
                user: { name: 'Ù…Ø³ØªÙƒØ´Ù', xp: 0 },
                todos: [
                    { id: 'td1', title: 'Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', completed: false, priority: 'high', pomodoros_total: 2, pomodoros_completed: 1, createdAt: new Date().toISOString() },
                    { id: 'td2', title: 'Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', completed: true, priority: 'medium', pomodoros_total: 1, pomodoros_completed: 1, createdAt: new Date().toISOString() }
                ],
                goals: [ { id: 'g1', title: 'Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…Ù† LifeMap', description: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ§Ù„Ù†Ø´Ø±.', deadline: '2025-07-15', pillar: 'career', createdAt: new Date().toISOString(), linkedItems: [] } ],
                settings: { theme: 'light', lastOpened: new Date().toISOString().slice(0, 10) },
                currentPage: 'dashboard',
            };
            this.saveState();
        },
        saveState() { localStorage.setItem('lifeMapState', JSON.stringify(this.state)); },
        navigateTo(pageId, isInitial = false) {
            document.querySelector('.page.active')?.classList.remove('active');
            this.state.currentPage = pageId;
            const newPage = document.getElementById(pageId);
            if(newPage) newPage.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                const isActive = item.dataset.page === pageId;
                item.classList.toggle('active', isActive);
                if (isActive) item.querySelector('.nav-indicator').style.opacity = '1';
                else item.querySelector('.nav-indicator').style.opacity = '0';
            });
            
            document.getElementById('fab-add').style.display = ['dashboard', 'graph', 'settings'].includes(pageId) ? 'none' : 'flex';
            
            if (!isInitial && newPage) {
                anime({ targets: newPage, opacity: [0, 1], translateY: [10, 0], duration: 400, easing: 'easeOutCubic' });
            }
            this.render();
        },
        render() {
            const renderMap = { 'dashboard': this.renderDashboard, 'todos': this.renderTodos, 'goals': this.renderGoals, 'graph': this.renderGraph, 'settings': this.renderSettings };
            renderMap[this.state.currentPage]?.call(this);
            this.saveState();
        },
        renderNav() { const navContainer = document.querySelector('.bottom-nav'); navContainer.innerHTML = this.navItems.map(item => `<div class="nav-item ${this.state.currentPage === item.id ? 'active' : ''}" data-page="${item.id}">${item.icon}<span>${item.label}</span><div class="nav-indicator"></div></div>`).join(''); },
        renderDashboard() {
            document.getElementById('greeting').textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${this.state.user.name || 'Ù…Ø³ØªÙƒØ´Ù'}!`;
            this.updateRank();
            
            const todosList = document.getElementById('dashboard-todos-list');
            const activeTodos = this.state.todos.filter(t => !t.completed).slice(0, 3);
            todosList.innerHTML = activeTodos.length === 0 ? `<p style="color: var(--text-secondary-color); text-align:center; padding: 20px 0;">Ø±Ø§Ø¦Ø¹! Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„ÙŠÙˆÙ….</p>` : activeTodos.map(todo => this.createListItem(todo, 'todo').outerHTML).join('');
            
            this.renderWeeklyProgressChart();
        },
        renderTodos() {
            const container = document.getElementById('todos-list-container');
            container.innerHTML = this.state.todos.length === 0 ? `<div class="card" style="text-align:center; padding: 40px 0; color: var(--text-secondary-color);">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ù…Ùƒ Ù„Ù„ÙŠÙˆÙ….</div>` : this.state.todos.map(todo => this.createListItem(todo, 'todo').outerHTML).join('');
        },
        renderGoals() {
            const container = document.getElementById('goals-list-container');
            container.innerHTML = this.state.goals.length === 0 ? `<div class="card" style="text-align:center; padding: 40px 0; color: var(--text-secondary-color);">Ø®Ø·Ø· Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ùƒ Ø¹Ø¨Ø± Ø¥Ø¶Ø§ÙØ© Ø£Ù‡Ø¯Ø§Ù Ø¬Ø¯ÙŠØ¯Ø©.</div>` : this.state.goals.map(goal => this.createListItem(goal, 'goal').outerHTML).join('');
        },
        renderSettings() {
            document.getElementById('username-input').value = this.state.user.name;
            document.getElementById('theme-toggle').checked = this.state.settings.theme === 'dark';
        },
        renderGraph() {
            const container = document.getElementById('graph-view-container');
            const nodes = new vis.DataSet([
                ...this.state.todos.map(i => ({ id: i.id, label: i.title, group: 'todos' })), 
                ...this.state.goals.map(i => ({ id: i.id, label: i.title, group: 'goals' })),
            ]);
            const edges = new vis.DataSet([
                ...[...this.state.todos, ...this.state.goals].flatMap(item => (item.linkedItems || []).map(linkId => ({ from: item.id, to: linkId })))
            ]);
            const data = { nodes, edges };
            const options = {
                layout: { hierarchical: false },
                groups: {
                    todos: { color: { background: '#22c55e', border: '#16a34a' }, font: { color: 'white' } },
                    goals: { color: { background: '#3b82f6', border: '#2563eb' }, font: { color: 'white' } },
                },
                edges: { color: { color: getComputedStyle(document.body).getPropertyValue('--border-color'), highlight: getComputedStyle(document.body).getPropertyValue('--accent-color') } },
                physics: { stabilization: true },
                interaction: { hover: true },
            };
            new vis.Network(container, data, options);
        },
        createListItem(item, type) {
            const div = document.createElement('div');
            div.className = `list-item ${type}-item`;
            div.dataset.id = item.id;
            div.dataset.type = type;
            let contentHTML = '';

            switch (type) {
                case 'todo':
                    div.classList.toggle('completed', item.completed);
                    contentHTML = `
                        <div class="checkbox" data-action="toggle-todo">${item.completed ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>' : ''}</div>
                        <div class="priority-dot ${item.priority}"></div>
                        <div class="content">
                            <div class="title">${item.title}</div>
                            <div class="subtitle">Ø§Ù„ØªØ±ÙƒÙŠØ²: ${item.pomodoros_completed || 0} / ${item.pomodoros_total} Ø¬Ù„Ø³Ø©</div>
                        </div>
                        <button class="icon-btn" data-action="start-pomodoro"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg></button>
                    `;
                    break;
                case 'goal':
                    const pillarIcons = { career: 'ğŸ’¼', finance: 'ğŸ’°', health: 'â¤ï¸â€ğŸ©¹', growth: 'ğŸ§ ' };
                    contentHTML = `
                        <div class="content">
                            <div class="title">${pillarIcons[item.pillar] || ''} ${item.title}</div>
                            <div class="subtitle">${item.description.substring(0, 50)}...</div>
                        </div>
                    `;
                    break;
            }
            div.innerHTML = contentHTML + `<button class="delete-btn" data-action="delete-item"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>`;
            return div;
        },
        setupEventListeners() {
            document.querySelector('.bottom-nav').addEventListener('click', e => {
                const navItem = e.target.closest('.nav-item');
                if (navItem) this.navigateTo(navItem.dataset.page);
            });
            document.getElementById('fab-add').addEventListener('click', () => this.openModal());
            document.getElementById('modal-form').addEventListener('submit', e => { e.preventDefault(); this.saveItem(); });
            document.getElementById('modal-cancel').addEventListener('click', () => this.closeModal('modal'));
            document.getElementById('username-input').addEventListener('change', e => { this.state.user.name = e.target.value; this.saveState(); this.renderDashboard(); });
            document.getElementById('theme-toggle').addEventListener('change', e => this.applyTheme(e.target.checked ? 'dark' : 'light'));
            document.getElementById('reset-data-btn').addEventListener('click', () => { this.showConfirmation('Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.', () => { this.resetState(); location.reload(); }); });
            
            document.querySelector('.container').addEventListener('click', e => {
                const actionTarget = e.target.closest('[data-action]');
                if (actionTarget) {
                    const action = actionTarget.dataset.action;
                    const listItem = actionTarget.closest('.list-item');
                    const id = listItem?.dataset.id;
                    const type = listItem?.dataset.type;

                    switch(action) {
                        case 'toggle-todo': this.toggleTodo(id); break;
                        case 'start-pomodoro': this.openPomodoroModal(id); break;
                        case 'delete-item': this.deleteItem(id, type); break;
                        case 'open-settings': this.navigateTo('settings'); break;
                    }
                } else {
                    const listItem = e.target.closest('.list-item');
                    if(listItem) this.openModal(listItem.dataset.id, listItem.dataset.type);
                }
            });
            
            // Pomodoro Modal listeners
            document.getElementById('pomodoro-start').addEventListener('click', () => this.startPomodoro());
            document.getElementById('pomodoro-pause').addEventListener('click', () => this.pausePomodoro());
            document.getElementById('pomodoro-reset').addEventListener('click', () => this.resetPomodoro());
            document.getElementById('pomodoro-close').addEventListener('click', () => this.closeModal('pomodoro-modal'));
        },
        openModal(id = null, type = null) {
            const modal = document.getElementById('modal');
            const form = document.getElementById('modal-form');
            form.reset();
            
            const currentType = type || (this.state.currentPage === 'todos' ? 'todo' : 'goal');
            
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-type').value = currentType;
            
            // Toggle visibility of fields based on type
            document.getElementById('todo-fields').style.display = currentType === 'todo' ? 'block' : 'none';
            document.getElementById('goal-fields').style.display = currentType === 'goal' ? 'block' : 'none';
            document.getElementById('description-group').style.display = currentType === 'goal' ? 'block' : 'none';

            if (id) {
                const item = this.findItem(id, currentType);
                document.getElementById('modal-title').textContent = `ØªØ¹Ø¯ÙŠÙ„ ${this.getItemTypeName(currentType)}`;
                document.getElementById('item-title').value = item.title;
                if(currentType === 'todo') {
                    document.getElementById('todo-priority').value = item.priority;
                    document.getElementById('todo-pomodoros').value = item.pomodoros_total;
                } else if (currentType === 'goal') {
                    document.getElementById('item-description').value = item.description || '';
                    document.getElementById('goal-deadline').value = item.deadline || '';
                    document.getElementById('goal-pillar').value = item.pillar || 'none';
                }
            } else {
                document.getElementById('modal-title').textContent = `Ø¥Ø¶Ø§ÙØ© ${this.getItemTypeName(currentType)}`;
            }
            
            modal.style.display = 'flex';
            anime({ targets: '#modal .modal-content', opacity: [0, 1], scale: [0.9, 1], duration: 300, easing: 'easeOutCubic' });
        },
        closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            anime({ targets: `#${modalId} .modal-content`, opacity: [1, 0], scale: [1, 0.9], duration: 300, easing: 'easeInCubic', complete: () => modal.style.display = 'none' });
        },
        saveItem() {
            const id = document.getElementById('edit-id').value;
            const type = document.getElementById('edit-type').value;
            const title = document.getElementById('item-title').value;
            let collection = this.state[type + 's'];
            
            let itemData;
            if (type === 'todo') {
                itemData = {
                    title: title,
                    priority: document.getElementById('todo-priority').value,
                    pomodoros_total: parseInt(document.getElementById('todo-pomodoros').value, 10),
                };
            } else if (type === 'goal') {
                itemData = {
                    title: title,
                    description: document.getElementById('item-description').value,
                    deadline: document.getElementById('goal-deadline').value,
                    pillar: document.getElementById('goal-pillar').value,
                };
            }
            
            if (id) {
                const itemIndex = collection.findIndex(i => i.id === id);
                if (itemIndex > -1) collection[itemIndex] = { ...collection[itemIndex], ...itemData };
            } else {
                const newItem = {
                    id: type.charAt(0) + Date.now(),
                    createdAt: new Date().toISOString(),
                    ...itemData
                };
                if(type === 'todo') {
                    newItem.completed = false;
                    newItem.pomodoros_completed = 0;
                }
                collection.push(newItem);
            }
            
            this.closeModal('modal');
            this.render();
        },
        deleteItem(id, type) {
            this.showConfirmation('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù€ ${this.getItemTypeName(type)}ØŸ`, () => {
                this.state[type + 's'] = this.state[type + 's'].filter(item => item.id !== id);
                this.render();
                this.closeModal('confirmation-modal');
            });
        },
        toggleTodo(id) {
            const todo = this.findItem(id, 'todo');
            if (!todo) return;
            todo.completed = !todo.completed;
            this.addXP(todo.completed ? 10 : -10);
            if(todo.completed) todo.completedAt = new Date().toISOString();
            else todo.completedAt = null;
            this.render();
        },
        findItem(id, type) { return this.state[type + 's']?.find(i => i.id === id); },
        getItemTypeName(type) { return ({ 'todo': 'Ù…Ù‡Ù…Ø©', 'goal': 'Ù‡Ø¯Ù' })[type] || 'Ø¹Ù†ØµØ±'; },
        addXP(amount) { this.state.user.xp += amount; this.updateRank(); },
        updateRank() {
            const currentXP = this.state.user.xp;
            const currentRank = this.ranks.filter(r => r.xp <= currentXP).pop() || this.ranks[0];
            const nextRank = this.ranks.find(r => r.xp > currentXP);
            document.getElementById('rank-name').textContent = currentRank.name;
            document.getElementById('xp-current').textContent = `${currentXP} XP`;
            if (nextRank) {
                const progress = ((currentXP - currentRank.xp) / (nextRank.xp - currentRank.xp)) * 100;
                document.getElementById('xp-next-rank').textContent = `${nextRank.xp} XP`;
                document.getElementById('xp-progress-bar').style.width = `${progress}%`;
            } else {
                document.getElementById('xp-next-rank').textContent = 'MAX';
                document.getElementById('xp-progress-bar').style.width = '100%';
            }
        },
        applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            this.state.settings.theme = theme;
            document.getElementById('theme-toggle').checked = (theme === 'dark');
            this.saveState();
            if(this.state.currentPage === 'dashboard') {
                this.renderWeeklyProgressChart();
            }
        },
        showConfirmation(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            
            const newConfirmBtn = document.getElementById('confirmation-confirm').cloneNode(true);
            document.getElementById('confirmation-confirm').parentNode.replaceChild(newConfirmBtn, document.getElementById('confirmation-confirm'));
            
            newConfirmBtn.addEventListener('click', onConfirm);
            document.getElementById('confirmation-cancel').addEventListener('click', () => this.closeModal('confirmation-modal'));

            modal.style.display = 'flex';
        },

        // Charting methods
        renderWeeklyProgressChart() {
            const ctx = document.getElementById('weekly-progress-chart')?.getContext('2d');
            if (!ctx) return;

            if (this.charts.weeklyProgress) {
                this.charts.weeklyProgress.destroy();
            }
            
            const today = new Date();
            const labels = [];
            const data = [];
            for(let i=6; i>=0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                labels.push(date.toLocaleDateString('ar-EG', { weekday: 'short' }));
                const dateString = date.toISOString().slice(0, 10);
                const completedTasks = this.state.todos.filter(t => t.completed && t.completedAt?.slice(0, 10) === dateString).length;
                data.push(completedTasks);
            }

            this.charts.weeklyProgress = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©',
                        data: data,
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-soft-color'),
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color'),
                        borderWidth: 2,
                        borderRadius: 8,
                        hoverBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        },

        // Pomodoro methods
        openPomodoroModal(taskId) {
            const task = this.findItem(taskId, 'todo');
            if(!task || task.completed) return;
            
            this.pomodoro.taskId = taskId;
            this.resetPomodoro(true);

            document.getElementById('pomodoro-task-title').textContent = task.title;
            const modal = document.getElementById('pomodoro-modal');
            modal.style.display = 'flex';
            anime({ targets: '#pomodoro-modal .modal-content', opacity: [0, 1], scale: [0.9, 1], duration: 300, easing: 'easeOutCubic' });
        },
        updateTimerDisplay() {
            const minutes = Math.floor(this.pomodoro.timeLeft / 60).toString().padStart(2, '0');
            const seconds = (this.pomodoro.timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('pomodoro-timer-display').textContent = `${minutes}:${seconds}`;
        },
        startPomodoro() {
            if(this.pomodoro.timer) clearInterval(this.pomodoro.timer);
            this.pomodoro.isPaused = false;
            document.getElementById('pomodoro-start').style.display = 'none';
            document.getElementById('pomodoro-pause').style.display = 'inline-flex';

            this.pomodoro.timer = setInterval(() => {
                this.pomodoro.timeLeft--;
                this.updateTimerDisplay();

                if (this.pomodoro.timeLeft < 0) {
                    clearInterval(this.pomodoro.timer);
                    this.handlePomodoroCompletion();
                }
            }, 1000);
        },
        pausePomodoro() {
            clearInterval(this.pomodoro.timer);
            this.pomodoro.isPaused = true;
            document.getElementById('pomodoro-start').style.display = 'inline-flex';
            document.getElementById('pomodoro-pause').style.display = 'none';
        },
        resetPomodoro(isOpening = false) {
            clearInterval(this.pomodoro.timer);
            this.pomodoro.isPaused = true;
            
            const task = this.findItem(this.pomodoro.taskId, 'todo');
            if(isOpening) { // reset to work session only when opening
                 this.pomodoro.mode = 'work';
                 this.pomodoro.timeLeft = this.pomodoro.initialTime = 25 * 60;
                 document.getElementById('pomodoro-status').textContent = 'Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²!';
            }
           
            this.updateTimerDisplay();
            document.getElementById('pomodoro-start').style.display = 'inline-flex';
            document.getElementById('pomodoro-pause').style.display = 'none';
        },
        handlePomodoroCompletion() {
            if (this.pomodoro.mode === 'work') {
                this.pomodoro.sessions++;
                const task = this.findItem(this.pomodoro.taskId, 'todo');
                if(task) {
                    task.pomodoros_completed = (task.pomodoros_completed || 0) + 1;
                    if(task.pomodoros_completed >= task.pomodoros_total) {
                        task.completed = true;
                        task.completedAt = new Date().toISOString();
                    }
                }
                this.addXP(25);
                
                // Switch to break
                if (this.pomodoro.sessions % 4 === 0) {
                    this.pomodoro.mode = 'longBreak';
                    this.pomodoro.timeLeft = this.pomodoro.initialTime = 15 * 60;
                    document.getElementById('pomodoro-status').textContent = 'Ø£Ø­Ø³Ù†Øª! Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø© Ø·ÙˆÙŠÙ„Ø©.';
                } else {
                    this.pomodoro.mode = 'shortBreak';
                    this.pomodoro.timeLeft = this.pomodoro.initialTime = 5 * 60;
                    document.getElementById('pomodoro-status').textContent = 'Ø±Ø§Ø¦Ø¹! Ø§Ø³ØªØ±Ø§Ø­Ø© Ù‚ØµÙŠØ±Ø©.';
                }
            } else { // Break finished
                this.pomodoro.mode = 'work';
                this.pomodoro.timeLeft = this.pomodoro.initialTime = 25 * 60;
                document.getElementById('pomodoro-status').textContent = 'Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²!';
            }

            this.updateTimerDisplay();
            document.getElementById('pomodoro-start').style.display = 'inline-flex';
            document.getElementById('pomodoro-pause').style.display = 'none';
            
            new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3').play();
            this.render(); // Re-render to update lists
        },
        
        initPWA() {
            // Placeholder for PWA initialization logic
        },

    };

    app.init();
});
</script>

</body>
</html>
