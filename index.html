<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeMap - خريطتك لحياة منظمة</title>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Anime.js for animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <!-- Vis.js for Graph View -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <style>
        /* ------------------------- */
        /* --- الإعدادات العامة والمتغيرات --- */
        /* ------------------------- */
        :root {
            --bg-light: #ffffff;
            --text-light: #1e1e1e;
            --primary-light: #4a90e2; /* أزرق ملكي */
            --secondary-light: #f4f4f4;
            --border-light: #e0e0e0;

            --bg-dark: #1a1a1a; /* رمادي فحمي */
            --text-dark: #f0f0f0;
            --primary-dark: #58a6ff;
            --secondary-dark: #2a2a2a;
            --border-dark: #3a3a3a;

            --font-family: 'Poppins', sans-serif;
            --border-radius: 12px;
            --transition-speed: 0.3s;
        }

        [data-theme="light"] {
            --bg-color: var(--bg-light);
            --text-color: var(--text-light);
            --primary-color: var(--primary-light);
            --secondary-color: var(--secondary-light);
            --border-color: var(--border-light);
        }

        [data-theme="dark"] {
            --bg-color: var(--bg-dark);
            --text-color: var(--text-dark);
            --primary-color: var(--primary-dark);
            --secondary-color: var(--secondary-dark);
            --border-color: var(--border-dark);
        }

        /* ------------------------- */
        /* --- التصميم الأساسي للجسم --- */
        /* ------------------------- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            padding: 20px;
            padding-bottom: 90px; /* لإفساح المجال لشريط التنقل */
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1, h2 {
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        h1 { font-size: 28px; }
        h2 { font-size: 22px; }

        /* ------------------------- */
        /* --- شريط التنقل السفلي --- */
        /* ------------------------- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: var(--secondary-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: background-color var(--transition-speed), border-top var(--transition-speed);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.6;
            transition: opacity 0.2s, color 0.2s;
        }
        
        .nav-item.active {
            opacity: 1;
            color: var(--primary-color);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .nav-item span {
            font-size: 12px;
        }

        /* ------------------------- */
        /* --- مكونات واجهة المستخدم العامة --- */
        /* ------------------------- */
        .card {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed);
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-family: var(--font-family);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .fab { /* زر الإضافة العائم */
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 999;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-bar-inner {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }

        /* ------------------------- */
        /* --- تصميم الأقسام --- */
        /* ------------------------- */
        
        /* لوحة القيادة */
        #dashboard .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #dashboard .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }
        
        #dashboard .stat-item {
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: var(--border-radius);
        }
        
        #dashboard .stat-item .icon { font-size: 24px; }
        #dashboard .stat-item .label { font-size: 14px; opacity: 0.7; margin-top: 5px; }
        #dashboard .stat-item .value { font-size: 20px; font-weight: 600; }
        
        /* العادات والأهداف واليوميات */
        .list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .list-item:hover {
            transform: translateY(-2px);
        }
        
        .list-item .icon-container {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }
        
        .list-item .content {
            flex-grow: 1;
        }

        .list-item .title {
            font-weight: 500;
        }

        .list-item .subtitle {
            font-size: 13px;
            opacity: 0.7;
        }
        
        .habit-item .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .habit-item.completed .checkbox {
            background-color: var(--primary-color);
            color: white;
        }
        
        .habit-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        /* خريطة الحياة */
        #graph-view-container {
            width: 100%;
            height: 60vh;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--secondary-color);
        }
        
        /* الإعدادات */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .theme-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }


        /* ------------------------- */
        /* --- النوافذ المنبثقة (Modals) --- */
        /* ------------------------- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: var(--bg-color);
            padding: 25px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-family: var(--font-family);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* رسالة الاحتفال */
        .celebration-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }
        
        .celebration-toast.show {
            opacity: 1;
            visibility: visible;
            top: 40px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.6;
        }
        .empty-state p {
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <!-- حاوية الصفحات -->
    <div class="container">
        <!-- 1. لوحة القيادة -->
        <div id="dashboard" class="page active">
            <div class="user-header">
                <div>
                    <h1 id="greeting">مرحباً، </h1>
                    <p id="day-intention" class="subtitle">نية اليوم: </p>
                </div>
                <div id="rank-display" class="stat-item" style="cursor:pointer;">
                    <div class="icon">🏆</div>
                    <div id="rank-name" class="value">مبتدئ</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="icon">⚡️</div>
                    <div id="energy-level" class="value">...</div>
                    <div class="label">الطاقة</div>
                </div>
                <div class="stat-item">
                    <div class="icon">😊</div>
                    <div id="mood-level" class="value">...</div>
                    <div class="label">المزاج</div>
                </div>
                <div class="stat-item">
                    <div class="icon">⭐</div>
                    <div id="xp-level" class="value">0</div>
                    <div class="label">XP</div>
                </div>
            </div>

            <div class="card" id="ai-recommendation-card">
                <h2>💡 توصية ذكية</h2>
                <p id="ai-recommendation-text">تبدو طاقتك رائعة اليوم! ما رأيك في البدء بهدف جديد؟</p>
            </div>
            
            <div class="card">
                <h2>🎯 أهدافك النشطة</h2>
                <div id="dashboard-goals-list">
                    <!-- سيتم ملء الأهداف هنا -->
                </div>
            </div>
        </div>

        <!-- 2. العادات -->
        <div id="habits" class="page">
            <h1>العادات</h1>
            <div id="habits-list"></div>
        </div>

        <!-- 3. الأهداف -->
        <div id="goals" class="page">
            <h1>الأهداف</h1>
            <div id="goals-list"></div>
        </div>

        <!-- 4. دفتر اليوميات -->
        <div id="journal" class="page">
            <h1>دفتر اليوميات</h1>
            <div class="card">
                <h2 id="journal-prompt-question">كيف تشعر اليوم؟</h2>
            </div>
            <div id="journal-entries-list"></div>
        </div>
        
        <!-- 5. خريطة الحياة -->
        <div id="graph" class="page">
            <h1>خريطة الحياة</h1>
            <p style="opacity: 0.7; margin-bottom: 15px;">شاهد كيف ترتبط أهدافك وعاداتك ويومياتك ببعضها البعض.</p>
            <div id="graph-view-container"></div>
        </div>

        <!-- 6. الإعدادات -->
        <div id="settings" class="page">
            <h1>الإعدادات</h1>
            <div class="card">
                <div class="settings-item">
                    <label for="username-input">الاسم</label>
                    <input type="text" id="username-input" style="width: 50%; text-align: left; direction: ltr;">
                </div>
                <div class="settings-item">
                    <span>الوضع الليلي</span>
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                 <div class="settings-item">
                    <span>إعادة تعيين البيانات</span>
                    <button id="reset-data-btn" class="btn btn-secondary" style="background-color: #e74c3c; color: white;">إعادة تعيين</button>
                </div>
            </div>
        </div>
    </div>

    <!-- زر الإضافة العائم -->
    <button id="fab-add" class="btn fab">+</button>

    <!-- شريط التنقل السفلي -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-page="dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
            <span>الرئيسية</span>
        </div>
        <div class="nav-item" data-page="habits">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.691v-2.985a2.25 2.25 0 00-2.25-2.25h-2.985a2.25 2.25 0 00-2.25 2.25v2.985" /></svg>
            <span>العادات</span>
        </div>
        <div class="nav-item" data-page="goals">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h15.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 013 19.875v-6.75zM3 8.625c0-.621.504-1.125 1.125-1.125h15.75c.621 0 1.125.504 1.125 1.125v.375c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 013 9V8.625z" /></svg>
            <span>الأهداف</span>
        </div>
        <div class="nav-item" data-page="journal">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
            <span>اليوميات</span>
        </div>
        <div class="nav-item" data-page="graph">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z" /></svg>
            <span>الخريطة</span>
        </div>
    </nav>
    
    <!-- النافذة المنبثقة (Modal) -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">إضافة عنصر جديد</h3>
            <form id="modal-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label for="item-title">العنوان</label>
                    <input type="text" id="item-title" required>
                </div>
                <div class="form-group" id="description-group">
                    <label for="item-description">الوصف (اختياري)</label>
                    <textarea id="item-description"></textarea>
                </div>
                <!-- حقول خاصة بالأهداف -->
                <div class="form-group" id="goal-fields" style="display: none;">
                    <label for="goal-deadline">تاريخ الانتهاء</label>
                    <input type="date" id="goal-deadline">
                </div>
                <!-- حقول خاصة باليوميات -->
                 <div class="form-group" id="journal-fields" style="display: none;">
                    <label>تقييم المزاج (1-5)</label>
                    <select id="journal-mood">
                        <option value="5">😃 رائع</option>
                        <option value="4">😊 جيد</option>
                        <option value="3">😐 عادي</option>
                        <option value="2">😕 سيء</option>
                        <option value="1">😞 سيء جدًا</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" id="modal-save" class="btn">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة الاقتراح التلقائي -->
    <div id="suggestion-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>💡 اقتراح ذكي</h3>
            <p id="suggestion-text">لاحظنا أنك ذكرت كلمات متعلقة ببعض أهدافك/عاداتك. هل تود ربط هذا الإدخال؟</p>
            <div id="suggestion-links"></div>
            <div class="modal-actions">
                <button type="button" id="suggestion-ignore" class="btn btn-secondary">تجاهل</button>
                <button type="button" id="suggestion-confirm" class="btn">نعم، اربط</button>
            </div>
        </div>
    </div>
    
    <!-- رسالة الاحتفال -->
    <div id="celebration-toast" class="celebration-toast"></div>


<script>
// --------------------------------------------------
// --- LifeMap: التطبيق الرئيسي
// --------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {

    const app = {
        // -------------------------
        // --- الحالة والبيانات
        // -------------------------
        state: {
            user: {
                name: 'مستكشف',
                xp: 0,
                rank: 'مبتدئ',
            },
            habits: [], // { id, title, completedToday, streak, createdAt }
            goals: [], // { id, title, description, deadline, progress, createdAt, linkedItems }
            journalEntries: [], // { id, content, mood, createdAt, linkedItems }
            settings: {
                theme: 'light',
                lastOpened: new Date().toISOString().slice(0, 10)
            },
            currentPage: 'dashboard',
            editingItem: null,
        },
        
        // الرُتب ونقاط الخبرة المطلوبة
        ranks: [
            { name: 'مبتدئ', xp: 0 },
            { name: 'منظم', xp: 100 },
            { name: 'مثابر', xp: 300 },
            { name: 'مُنجز', xp: 700 },
            { name: 'خبير', xp: 1500 },
            { name: 'سيد الحياة', xp: 3000 },
        ],
        
        // أسئلة اليوميات
        journalPrompts: [
            "ما هو الشيء الذي جعلك تبتسم اليوم؟",
            "صف تحديًا واجهته وكيف تعاملت معه.",
            "ما هو الشيء الذي تعلمته اليوم عن نفسك أو عن العالم؟",
            "اكتب عن لحظة شعرت فيها بالامتنان اليوم.",
            "ما هي نيتك ليوم غد؟"
        ],

        // -------------------------
        // --- التهيئة والبدء
        // -------------------------
        init() {
            this.loadState();
            this.setupEventListeners();
            this.checkDate();
            this.navigateTo(this.state.currentPage);
            this.applyTheme(this.state.settings.theme);
        },

        // -------------------------
        // --- إدارة البيانات (LocalStorage)
        // -------------------------
        saveState() {
            localStorage.setItem('lifeMapState', JSON.stringify(this.state));
        },
        
        loadState() {
            const savedState = localStorage.getItem('lifeMapState');
            if (savedState) {
                this.state = JSON.parse(savedState);
            }
        },
        
        // -------------------------
        // --- التنقل بين الصفحات
        // -------------------------
        navigateTo(pageId) {
            this.state.currentPage = pageId;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === pageId);
            });
            
            // إظهار أو إخفاء زر الإضافة حسب الصفحة
            const fab = document.getElementById('fab-add');
            if (['dashboard', 'settings', 'graph'].includes(pageId)) {
                fab.style.display = 'none';
            } else {
                fab.style.display = 'flex';
            }
            
            this.render();
        },
        
        // -------------------------
        // --- العرض والتحديث (Render)
        // -------------------------
        render() {
            // تحديث الواجهة بناءً على الصفحة الحالية
            switch (this.state.currentPage) {
                case 'dashboard': this.renderDashboard(); break;
                case 'habits': this.renderHabits(); break;
                case 'goals': this.renderGoals(); break;
                case 'journal': this.renderJournal(); break;
                case 'graph': this.renderGraph(); break;
                case 'settings': this.renderSettings(); break;
            }
            this.saveState();
        },

        renderDashboard() {
            const { user } = this.state;
            document.getElementById('greeting').textContent = `مرحباً، ${user.name}`;
            document.getElementById('xp-level').textContent = user.xp;
            document.getElementById('rank-name').textContent = user.rank;
            
            // حساب متوسط المزاج والطاقة من يوميات اليوم
            const todayEntries = this.state.journalEntries.filter(e => e.createdAt.startsWith(new Date().toISOString().slice(0, 10)));
            const avgMood = todayEntries.length > 0 ? (todayEntries.reduce((sum, e) => sum + e.mood, 0) / todayEntries.length).toFixed(1) : 'N/A';
            
            // يمكن ربط الطاقة بإنجاز العادات
            const completedHabitsToday = this.state.habits.filter(h => h.completedToday).length;
            const totalHabits = this.state.habits.length;
            const energy = totalHabits > 0 ? `${Math.round((completedHabitsToday / totalHabits) * 100)}%` : 'N/A';

            document.getElementById('mood-level').textContent = avgMood;
            document.getElementById('energy-level').textContent = energy;

            // عرض الأهداف النشطة
            const goalsList = document.getElementById('dashboard-goals-list');
            goalsList.innerHTML = '';
            const activeGoals = this.state.goals.filter(g => g.progress < 100).slice(0, 3);
            if (activeGoals.length === 0) {
                goalsList.innerHTML = `<p class="empty-state">لا توجد أهداف نشطة حاليًا.</p>`;
            } else {
                activeGoals.forEach(goal => {
                    const goalEl = document.createElement('div');
                    goalEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span>${goal.title}</span>
                            <span style="font-size: 14px; opacity: 0.8;">${goal.progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-inner" style="width: ${goal.progress}%;"></div>
                        </div>
                    `;
                    goalsList.appendChild(goalEl);
                });
            }
        },

        renderHabits() {
            const list = document.getElementById('habits-list');
            list.innerHTML = '';
            if (this.state.habits.length === 0) {
                list.innerHTML = `<div class="empty-state">
                    <p>ابدأ ببناء عادات إيجابية.</p>
                    <p>اضغط على زر '+' للإضافة.</p>
                </div>`;
                return;
            }
            this.state.habits.forEach(habit => {
                const item = document.createElement('div');
                item.className = `list-item habit-item ${habit.completedToday ? 'completed' : ''}`;
                item.dataset.id = habit.id;
                item.innerHTML = `
                    <div class="checkbox" data-action="toggle-habit">
                        ${habit.completedToday ? '✔' : ''}
                    </div>
                    <div class="content">
                        <div class="title">${habit.title}</div>
                        <div class="subtitle">الاستمرارية: ${habit.streak} أيام</div>
                    </div>
                    <button data-action="delete-habit" style="background:none; border:none; color: #e74c3c; cursor:pointer;">🗑️</button>
                `;
                list.appendChild(item);
            });
        },
        
        renderGoals() {
            const list = document.getElementById('goals-list');
            list.innerHTML = '';
            if (this.state.goals.length === 0) {
                list.innerHTML = `<div class="empty-state">
                    <p>حدد أهدافك الكبيرة.</p>
                    <p>اضغط على زر '+' للإضافة.</p>
                </div>`;
                return;
            }
            this.state.goals.forEach(goal => {
                const item = document.createElement('div');
                item.className = 'card';
                item.dataset.id = goal.id;
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h3 class="title">${goal.title}</h3>
                            <p class="subtitle" style="margin-top: 5px;">${goal.description || ''}</p>
                            ${goal.deadline ? `<p class="subtitle" style="margin-top: 5px;">تاريخ الانتهاء: ${goal.deadline}</p>` : ''}
                        </div>
                        <button data-action="delete-goal" style="background:none; border:none; color: #e74c3c; cursor:pointer;">🗑️</button>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span>التقدم</span>
                            <span>${goal.progress}%</span>
                        </div>
                        <input type="range" min="0" max="100" value="${goal.progress}" data-action="update-goal-progress" class="goal-progress-slider" style="width: 100%; margin-top: 5px;">
                    </div>
                `;
                list.appendChild(item);
            });
        },
        
        renderJournal() {
            const list = document.getElementById('journal-entries-list');
            document.getElementById('journal-prompt-question').textContent = this.getDailyPrompt();
            list.innerHTML = '';
            if (this.state.journalEntries.length === 0) {
                list.innerHTML = `<div class="empty-state">
                    <p>دوّن أفكارك ومشاعرك.</p>
                    <p>اضغط على زر '+' لإضافة إدخال جديد.</p>
                </div>`;
                return;
            }
            // عرض اليوميات من الأحدث للأقدم
            [...this.state.journalEntries].reverse().forEach(entry => {
                const item = document.createElement('div');
                item.className = 'card';
                item.dataset.id = entry.id;
                const moodEmoji = ['😞', '😕', '😐', '😊', '😃'][entry.mood - 1];
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <p class="subtitle">${new Date(entry.createdAt).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} - المزاج: ${moodEmoji}</p>
                            <p style="margin-top: 10px; white-space: pre-wrap;">${entry.content}</p>
                        </div>
                        <button data-action="delete-journal" style="background:none; border:none; color: #e74c3c; cursor:pointer;">🗑️</button>
                    </div>
                `;
                list.appendChild(item);
            });
        },
        
        renderGraph() {
            const container = document.getElementById('graph-view-container');
            const nodes = [];
            const edges = [];

            // إضافة عقد الأهداف
            this.state.goals.forEach(goal => {
                nodes.push({ id: `g-${goal.id}`, label: goal.title, group: 'goals', shape: 'box', color: '#4a90e2' });
            });

            // إضافة عقد العادات
            this.state.habits.forEach(habit => {
                nodes.push({ id: `h-${habit.id}`, label: habit.title, group: 'habits', shape: 'ellipse', color: '#50e3c2' });
            });
            
            // إضافة عقد اليوميات والروابط
            this.state.journalEntries.forEach(entry => {
                const moodEmoji = ['😞', '😕', '😐', '😊', '😃'][entry.mood - 1];
                nodes.push({ id: `j-${entry.id}`, label: `يومية ${moodEmoji}`, group: 'journal', shape: 'circle', color: '#f5a623' });
                if (entry.linkedItems && entry.linkedItems.length > 0) {
                    entry.linkedItems.forEach(link => {
                        edges.push({ from: `j-${entry.id}`, to: link });
                    });
                }
            });

            const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = {
                layout: {
                    hierarchical: false
                },
                edges: {
                    color: "#a0a0a0"
                },
                physics: {
                    forceAtlas2Based: {
                        gravitationalConstant: -26,
                        centralGravity: 0.005,
                        springLength: 230,
                        springConstant: 0.18
                    },
                    maxVelocity: 146,
                    solver: "forceAtlas2Based",
                    timestep: 0.35,
                    stabilization: { iterations: 150 }
                },
                nodes: {
                    font: {
                        color: getComputedStyle(document.body).getPropertyValue('--text-color'),
                        family: 'Poppins'
                    }
                }
            };
            new vis.Network(container, data, options);
        },
        
        renderSettings() {
            document.getElementById('username-input').value = this.state.user.name;
            document.getElementById('theme-toggle').checked = this.state.settings.theme === 'dark';
        },

        // -------------------------
        // --- إدارة الأحداث (Events)
        // -------------------------
        setupEventListeners() {
            // التنقل
            document.querySelector('.bottom-nav').addEventListener('click', e => {
                const navItem = e.target.closest('.nav-item');
                if (navItem) {
                    this.navigateTo(navItem.dataset.page);
                }
            });
            
            // زر الإضافة العائم
            document.getElementById('fab-add').addEventListener('click', () => {
                this.openModal();
            });
            
            // أحداث النافذة المنبثقة
            document.getElementById('modal-cancel').addEventListener('click', () => this.closeModal());
            document.getElementById('modal-form').addEventListener('submit', e => {
                e.preventDefault();
                this.saveItem();
            });

            // أحداث القوائم (باستخدام تفويض الأحداث)
            document.querySelector('.container').addEventListener('click', e => {
                const action = e.target.dataset.action;
                if (!action) return;
                
                const itemElement = e.target.closest('.list-item, .card');
                const id = itemElement ? itemElement.dataset.id : null;

                switch(action) {
                    case 'toggle-habit': this.toggleHabit(id); break;
                    case 'delete-habit': this.deleteItem('habits', id); break;
                    case 'delete-goal': this.deleteItem('goals', id); break;
                    case 'delete-journal': this.deleteItem('journalEntries', id); break;
                }
            });
            
            // حدث تغيير شريط تقدم الهدف
            document.querySelector('.container').addEventListener('input', e => {
                if (e.target.matches('.goal-progress-slider')) {
                    const id = e.target.closest('.card').dataset.id;
                    const progress = parseInt(e.target.value);
                    this.updateGoalProgress(id, progress);
                }
            });
            
            // إعدادات
            document.getElementById('theme-toggle').addEventListener('change', e => {
                this.applyTheme(e.target.checked ? 'dark' : 'light');
            });
            document.getElementById('username-input').addEventListener('change', e => {
                this.state.user.name = e.target.value;
                this.saveState();
                this.renderDashboard();
            });
            document.getElementById('reset-data-btn').addEventListener('click', () => {
                if(confirm('هل أنت متأكد من رغبتك في إعادة تعيين جميع بياناتك؟ لا يمكن التراجع عن هذا الإجراء.')) {
                    localStorage.removeItem('lifeMapState');
                    window.location.reload();
                }
            });
            
            // نافذة الاقتراح
            document.getElementById('suggestion-ignore').addEventListener('click', () => this.closeSuggestionModal());
            document.getElementById('suggestion-confirm').addEventListener('click', () => this.confirmSuggestion());
        },
        
        // -------------------------
        // --- منطق العمليات (CRUD)
        // -------------------------
        openModal() {
            const modal = document.getElementById('modal');
            const form = document.getElementById('modal-form');
            form.reset();
            document.getElementById('edit-id').value = '';
            
            // إخفاء وإظهار الحقول حسب الصفحة
            document.getElementById('description-group').style.display = 'none';
            document.getElementById('goal-fields').style.display = 'none';
            document.getElementById('journal-fields').style.display = 'none';

            switch(this.state.currentPage) {
                case 'habits':
                    document.getElementById('modal-title').textContent = 'إضافة عادة جديدة';
                    break;
                case 'goals':
                    document.getElementById('modal-title').textContent = 'إضافة هدف جديد';
                    document.getElementById('description-group').style.display = 'block';
                    document.getElementById('goal-fields').style.display = 'block';
                    break;
                case 'journal':
                    document.getElementById('modal-title').textContent = 'إضافة إدخال يومي';
                    document.getElementById('description-group').style.display = 'block';
                    document.getElementById('item-description').previousElementSibling.textContent = 'محتوى اليومية';
                    document.getElementById('journal-fields').style.display = 'block';
                    break;
            }
            
            modal.style.display = 'flex';
        },
        
        closeModal() {
            document.getElementById('modal').style.display = 'none';
        },
        
        saveItem() {
            const id = document.getElementById('edit-id').value || `id-${Date.now()}`;
            const title = document.getElementById('item-title').value;
            if (!title && this.state.currentPage !== 'journal') {
                alert('الرجاء إدخال عنوان.');
                return;
            }

            switch(this.state.currentPage) {
                case 'habits':
                    this.state.habits.push({ id, title, completedToday: false, streak: 0, createdAt: new Date().toISOString() });
                    break;
                case 'goals':
                    const description = document.getElementById('item-description').value;
                    const deadline = document.getElementById('goal-deadline').value;
                    this.state.goals.push({ id, title, description, deadline, progress: 0, createdAt: new Date().toISOString(), linkedItems: [] });
                    break;
                case 'journal':
                    const content = document.getElementById('item-description').value;
                     if (!content) {
                        alert('الرجاء كتابة محتوى اليومية.');
                        return;
                    }
                    const mood = parseInt(document.getElementById('journal-mood').value);
                    const newEntry = { id, content, mood, createdAt: new Date().toISOString(), linkedItems: [] };
                    this.state.journalEntries.push(newEntry);
                    this.checkForAutomaticLinks(newEntry);
                    break;
            }
            
            this.closeModal();
            this.render();
        },
        
        deleteItem(type, id) {
            if (confirm('هل أنت متأكد من الحذف؟')) {
                this.state[type] = this.state[type].filter(item => item.id !== id);
                this.render();
            }
        },
        
        // -------------------------
        // --- منطق التطبيق الخاص
        // -------------------------
        toggleHabit(id) {
            const habit = this.state.habits.find(h => h.id === id);
            if (habit) {
                if (!habit.completedToday) {
                    habit.completedToday = true;
                    habit.streak++;
                    this.addXP(10); // 10 نقاط عند إنجاز عادة
                } else {
                    habit.completedToday = false;
                    habit.streak--;
                    this.addXP(-10);
                }
                this.render();
            }
        },
        
        updateGoalProgress(id, progress) {
            const goal = this.state.goals.find(g => g.id === id);
            if (goal) {
                const oldProgress = goal.progress;
                goal.progress = progress;
                if (progress === 100 && oldProgress < 100) {
                    this.addXP(50); // 50 نقطة عند إكمال هدف
                    this.showCelebration(`🎉 هدف مكتمل: ${goal.title}`);
                }
                // تحديث العرض في لوحة القيادة فورًا
                if (this.state.currentPage === 'dashboard') {
                    this.renderDashboard();
                }
            }
            this.saveState(); // حفظ فوري عند سحب الشريط
        },

        addXP(amount) {
            this.state.user.xp += amount;
            if (this.state.user.xp < 0) this.state.user.xp = 0;
            
            const currentRank = this.ranks.find(r => r.name === this.state.user.rank);
            const nextRank = this.ranks.find(r => r.xp > currentRank.xp && this.state.user.xp >= r.xp);
            
            if (nextRank) {
                this.state.user.rank = nextRank.name;
                this.showCelebration(`🏆 ترقية! لقد وصلت إلى رتبة ${nextRank.name}`);
            }
            
            this.render();
        },
        
        showCelebration(message) {
            const toast = document.getElementById('celebration-toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            anime({
                targets: toast,
                translateY: [20, 0],
                opacity: [0, 1],
                duration: 500,
                easing: 'easeOutExpo'
            });
            
            setTimeout(() => {
                anime({
                    targets: toast,
                    translateY: [0, -20],
                    opacity: [1, 0],
                    duration: 500,
                    easing: 'easeInExpo',
                    complete: () => {
                        toast.classList.remove('show');
                    }
                });
            }, 3000);
        },
        
        applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            this.state.settings.theme = theme;
            this.saveState();
            // يجب إعادة رسم الخريطة لتحديث ألوان الخطوط
            if (this.state.currentPage === 'graph') {
                this.renderGraph();
            }
        },

        checkDate() {
            const today = new Date().toISOString().slice(0, 10);
            if (this.state.settings.lastOpened !== today) {
                // يوم جديد، إعادة تعيين العادات
                this.state.habits.forEach(habit => {
                    if (!habit.completedToday) {
                        habit.streak = 0; // كسر الاستمرارية
                    }
                    habit.completedToday = false;
                });
                this.state.settings.lastOpened = today;
                this.saveState();
            }
        },
        
        getDailyPrompt() {
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            return this.journalPrompts[dayOfYear % this.journalPrompts.length];
        },
        
        // --- الربط التلقائي والذكي ---
        checkForAutomaticLinks(journalEntry) {
            const content = journalEntry.content.toLowerCase();
            const suggestions = [];
            
            this.state.goals.forEach(goal => {
                if (content.includes(goal.title.toLowerCase())) {
                    suggestions.push({ id: `g-${goal.id}`, text: `هدف: ${goal.title}` });
                }
            });
            
            this.state.habits.forEach(habit => {
                if (content.includes(habit.title.toLowerCase())) {
                     suggestions.push({ id: `h-${habit.id}`, text: `عادة: ${habit.title}` });
                }
            });
            
            if (suggestions.length > 0) {
                this.openSuggestionModal(journalEntry.id, suggestions);
            }
        },
        
        openSuggestionModal(entryId, suggestions) {
            this.editingItem = { entryId, suggestions };
            const modal = document.getElementById('suggestion-modal');
            const linksContainer = document.getElementById('suggestion-links');
            linksContainer.innerHTML = '';
            suggestions.forEach(sugg => {
                linksContainer.innerHTML += `<p>• ${sugg.text}</p>`;
            });
            modal.style.display = 'flex';
        },
        
        closeSuggestionModal() {
            document.getElementById('suggestion-modal').style.display = 'none';
            this.editingItem = null;
        },
        
        confirmSuggestion() {
            if (this.editingItem) {
                const entry = this.state.journalEntries.find(e => e.id === this.editingItem.entryId);
                if (entry) {
                    this.editingItem.suggestions.forEach(sugg => {
                        if (!entry.linkedItems.includes(sugg.id)) {
                            entry.linkedItems.push(sugg.id);
                        }
                    });
                }
            }
            this.closeSuggestionModal();
            this.render();
        }
    };

    app.init(); // بدء تشغيل التطبيق
});
</script>

</body>
</html>
